- name: Ensure ~/.kube directory exists
  file:
    path: "/home/{{ ansible_user_id }}/.kube"
    state: directory
    mode: "0700"
    owner: "{{ ansible_user_id }}"

- name: Install Docker
  apt:
    name:
      - docker.io
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Install Minikube
  get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: "0755"

- name: Start Minikube cluster
  become: false
  command: minikube start --driver=docker
  register: minikube_start
  changed_when: "'Done!' in minikube_start.stdout"

- name: Wait for Minikube to be ready
  wait_for:
    path: "{{ kubeconfig_path }}"
    timeout: 60

- name: Apply Kubernetes manifests in order
  kubernetes.core.k8s:
    state: present
    namespace: default
    src: "{{ k8s_dir }}/{{ item }}"
  loop: "{{ manifest_order }}"
  loop_control:
    label: "{{ item }}"
